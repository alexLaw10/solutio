name: CI Pipeline

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:

jobs:
  # ============================================
  # DESKTOP - Lint, Build e Testes
  # ============================================
  desktop:
    name: Desktop (Angular)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.7'
          cache: 'npm'
          cache-dependency-path: solutio-v2/package-lock.json

      - name: Setup Nx Cache
        uses: actions/cache@v4
        with:
          path: solutio-v2/.nx/cache
          key: nx-${{ runner.os }}-${{ hashFiles('solutio-v2/nx.json', 'solutio-v2/package-lock.json') }}
          restore-keys: |
            nx-${{ runner.os }}-

      - name: Instalar dependências Desktop
        working-directory: ./solutio-v2
        run: npm ci

      - name: Executar Lint Desktop
        working-directory: ./solutio-v2
        run: npm run lint

      - name: Build Design System
        working-directory: ./solutio-v2
        run: npm run build:ds
        continue-on-error: true

      - name: Build Dashboard
        working-directory: ./solutio-v2
        run: npm run build

      - name: Executar Testes Unitários Desktop
        working-directory: ./solutio-v2
        run: npm test
        continue-on-error: false

      - name: Upload Coverage Reports
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./solutio-v2/coverage/apps/dashboard/coverage-final.json
          flags: desktop
          name: desktop-coverage
          fail_ci_if_error: false

  # ============================================
  # DESKTOP - Testes E2E
  # ============================================
  desktop-e2e:
    name: Desktop E2E Tests
    runs-on: ubuntu-latest
    needs: desktop
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.7'
          cache: 'npm'
          cache-dependency-path: solutio-v2/package-lock.json

      - name: Setup Nx Cache
        uses: actions/cache@v4
        with:
          path: solutio-v2/.nx/cache
          key: nx-${{ runner.os }}-${{ hashFiles('solutio-v2/nx.json', 'solutio-v2/package-lock.json') }}
          restore-keys: |
            nx-${{ runner.os }}-

      - name: Instalar dependências Desktop
        working-directory: ./solutio-v2
        run: npm ci

      - name: Build Dashboard para E2E
        working-directory: ./solutio-v2
        run: npm run build

      - name: Executar Testes E2E
        working-directory: ./solutio-v2
        run: nx e2e dashboard-e2e --configuration=ci
        continue-on-error: false
        env:
          CI: true

      - name: Upload Screenshots (se falhar)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: solutio-v2/apps/dashboard-e2e/cypress/screenshots
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload Videos (se falhar)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: solutio-v2/apps/dashboard-e2e/cypress/videos
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload E2E Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-reports
          path: solutio-v2/apps/dashboard-e2e/cypress/reports
          retention-days: 7
          if-no-files-found: ignore

  # ============================================
  # MOBILE - Lint, Build e Testes
  # ============================================
  mobile:
    name: Mobile (React Native/Expo)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.20.7'
          cache: 'npm'
          cache-dependency-path: solutio-mobile/solutio-mobile-dashboard/package-lock.json

      - name: Instalar dependências Mobile
        working-directory: ./solutio-mobile/solutio-mobile-dashboard
        run: npm ci

      - name: Executar Lint Mobile
        working-directory: ./solutio-mobile/solutio-mobile-dashboard
        run: npm run lint

      - name: Executar Testes Unitários Mobile
        working-directory: ./solutio-mobile/solutio-mobile-dashboard
        run: npm test
        continue-on-error: false

      - name: Executar Testes com Cobertura Mobile
        working-directory: ./solutio-mobile/solutio-mobile-dashboard
        run: npm run test:coverage
        continue-on-error: false

      - name: Upload Coverage Reports Mobile
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./solutio-mobile/solutio-mobile-dashboard/coverage/coverage-final.json
          flags: mobile
          name: mobile-coverage
          fail_ci_if_error: false

  # ============================================
  # VALIDAÇÃO FINAL
  # ============================================
  validate:
    name: Validação Final
    runs-on: ubuntu-latest
    needs: [desktop, desktop-e2e, mobile]
    
    steps:
      - name: Verificar status dos jobs
        run: |
          echo "✅ Todos os jobs foram executados com sucesso!"
          echo "✅ Desktop: Lint, Build e Testes - OK"
          echo "✅ Desktop: Testes E2E - OK"
          echo "✅ Mobile: Lint e Testes - OK"
